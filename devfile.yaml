schemaVersion: 2.2.0
metadata:
  name: python-node
  version: 1.4.0
  displayName: Python + Node (React) — Dev Spaces
  description: OpenShift-friendly workspace with Python and Node.js for React apps; installs Python deps from requirements.txt

projects: []

components:
  # ---- Python toolchain ----
  - name: tools
    container:
      # OpenShift-friendly base (runs as arbitrary UID)
      image: registry.access.redhat.com/ubi9/python-312
      memoryLimit: 8Gi
      cpuRequest: "500m"
      cpuLimit: "4"
      mountSources: true
      sourceMapping: /projects
      env:
        - name: VIRTUAL_ENV
          value: /projects/.venv
        - name: PATH
          value: /projects/.venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        - name: PIP_DISABLE_PIP_VERSION_CHECK
          value: "1"
        - name: PIP_NO_CACHE_DIR
          value: "1"
      volumeMounts:
        - name: pip-cache
          path: /home/user/.cache/pip
      command: ["sh"]
      args: ["-c", "while sleep 1000; do :; done"]

  - name: pip-cache
    volume:
      size: 2Gi

  # ---- Node.js toolchain for React ----
  - name: node
    container:
      image: registry.access.redhat.com/ubi9/nodejs-24
      memoryLimit: 4Gi
      cpuRequest: "300m"
      cpuLimit: "2"
      mountSources: true
      sourceMapping: /projects
      env:
        # Set this if your React app is in a subfolder (e.g., frontend)
        # Use '.' if package.json is at the repo root
        - name: FRONTEND_DIR
          value: .
        - name: CI
          value: "false"   # prevents create-react-app from treating missing git as fatal
        - name: NPM_CONFIG_FUND
          value: "false"
        - name: NPM_CONFIG_AUDIT
          value: "false"
      volumeMounts:
        - name: npm-cache
          path: /home/user/.npm
      endpoints:
        - name: react-dev
          targetPort: 3000
          exposure: public
          protocol: http
      command: ["sh"]
      args: ["-c", "while sleep 1000; do :; done"]

  - name: npm-cache
    volume:
      size: 2Gi

commands:
  # ---------- Python side ----------
  - id: bootstrap-venv-and-install
    exec:
      component: tools
      workingDir: /projects
      label: "Bootstrap venv & install from requirements.txt (non-fatal)"
      commandLine: |
        bash -lc '
          LOG=/projects/.devspaces/install.log
          mkdir -p /projects/.devspaces
          {
            echo "== $(date) bootstrap start =="
            python3 -m venv /projects/.venv || true
            . /projects/.venv/bin/activate 2>/dev/null || true
            python -m pip install --upgrade pip wheel setuptools || true
            if [ -f /projects/walkguardianai/requirements.txt ]; then
              echo "Installing from requirements.txt ..."
              pip install -r /projects/walkguardianai/requirements.txt || echo "[WARN] pip install failed (see above)."
            else
              echo "requirements.txt not found; skipping."
            fi
            if ! grep -q "/projects/.venv/bin/activate" ~/.bashrc 2>/dev/null; then
              echo ". /projects/.venv/bin/activate" >> ~/.bashrc || true
            fi
            echo "== $(date) bootstrap end =="
          } | tee -a "$LOG"
          # Always succeed to avoid workspace crash
          exit 0
        '
      group:
        kind: build
        isDefault: true

  # Manual, strict installer you can run when ready; fails visibly in the terminal if something’s wrong.
  - id: install-deps
    exec:
      component: tools
      workingDir: /projects
      label: "Install deps from requirements.txt (manual)"
      commandLine: |
        bash -lc '
          set -euxo pipefail
          python -m pip install --upgrade pip wheel setuptools
          test -f /projects/walkguardianai/requirements.txt
          python3 -m venv /projects/.venv
          . /projects/.venv/bin/activate
          python -m pip install --upgrade pip wheel setuptools
          pip install -r /projects/walkguardianai/requirements.txt
          if ! grep -q "/projects/.venv/bin/activate" ~/.bashrc 2>/dev/null; then
            echo ". /projects/.venv/bin/activate" >> ~/.bashrc
          fi
          python --version
        '
      group:
        kind: run

  - id: show-versions
    exec:
      component: tools
      workingDir: /projects
      label: "Show Python & package versions"
      commandLine: |
        bash -lc '
          . /projects/.venv/bin/activate 2>/dev/null || true
          python --version || true
        '
      group:
        kind: run

  # ---------- Node/React side ----------
  - id: node-install
    exec:
      component: node
      workingDir: /projects
      label: "Node: install frontend deps (npm ci || npm install)"
      commandLine: |
        bash -lc '
          set -euo pipefail
          cd "/projects/${FRONTEND_DIR:-.}"
          if [ ! -f package.json ]; then
            echo "No package.json in $(pwd); set FRONTEND_DIR env to your React app folder." >&2
            exit 0
          fi
          if command -v npm >/dev/null 2>&1; then
            (npm ci || npm install)
          else
            echo "npm not found" >&2
            exit 1
          fi
        '
      group: { kind: build }

  - id: node-start
    exec:
      component: node
      workingDir: /projects
      label: "Node: start React dev server (exposes endpoint :3000)"
      commandLine: |
        bash -lc '
          set -euo pipefail
          cd "/projects/${FRONTEND_DIR:-.}"
          if [ ! -f package.json ]; then
            echo "No package.json in $(pwd); set FRONTEND_DIR env to your React app folder." >&2
            exit 1
          fi
          # Common scripts: start / dev
          if npm run | grep -qE " start| dev"; then
            # CRA uses PORT, Vite uses default 5173; we’ll force 3000 for the exposed endpoint
            export PORT=3000
            export HOST=0.0.0.0
            if npm run | grep -q " dev"; then
              npm run dev -- --host 0.0.0.0 --port 3000
            else
              npm run start
            fi
          else
            echo "No start/dev script in package.json." >&2
            exit 1
          fi
        '
      group: { kind: run }

events:
  postStart:
    - bootstrap-venv-and-install
